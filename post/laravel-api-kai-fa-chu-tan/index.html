<html>
<head>
    <meta charset="utf-8" />
<meta name="description" content="" />
<meta name="viewport" content="width=device-width, initial-scale=1" />

<title>Laravel API开发初探 | GeekGhc&#39;s Blog</title>

<link rel="shortcut icon" href="https://GeekGhc.github.io/favicon.ico?v=1736692760153">

<link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" rel="stylesheet">
<link rel="stylesheet" href="https://GeekGhc.github.io/styles/main.css">
<!-- <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.5.0/dist/css/bootstrap.min.css"> -->

<style>
    hr {
        margin-top: 1rem;
        margin-bottom: 1rem;
        border: 0;
        border-top: 1px solid rgba(0, 0, 0, 0.1);
    }
</style>

<script src="https://cdn.jsdelivr.net/npm/@highlightjs/cdn-assets/highlight.min.js"></script>
<script src="https://cdn.bootcss.com/highlight.js/9.15.10/languages/dockerfile.min.js"></script>
<script src="https://cdn.bootcss.com/highlight.js/9.15.10/languages/dart.min.js"></script>

<!-- <script src="https://cdn.jsdelivr.net/npm/moment@2.27.0/moment.min.js"></script> -->
<!-- <script src="https://cdn.jsdelivr.net/npm/jquery@3.5.1/dist/jquery.slim.min.js"></script> -->
<!-- <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js"></script> -->
<!-- <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.0/dist/js/bootstrap.min.js"></script> -->
<!-- DEMO JS -->
<!--<script src="media/scripts/index.js"></script>-->


    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.css">
</head>
<body>
<div class="main gt-bg-theme-color-first">
    <style>
    /* 导航栏样式 */
    .navbar {
        position: relative;
        display: -ms-flexbox;
        display: flex;
        -ms-flex-wrap: wrap;
        flex-wrap: wrap;
        -ms-flex-align: center;
        align-items: center;
        -ms-flex-pack: justify;
        justify-content: space-between;
        padding: 0.5rem 1rem;
    }

    .navbar-brand {
        display: inline-block;
        padding-top: 0.3125rem;
        padding-bottom: 0.3125rem;
        margin-right: 1rem;
        font-size: 1.25rem;
        line-height: inherit;
        white-space: nowrap;
    }

    .navbar-brand:hover,
    .navbar-brand:focus {
        text-decoration: none;
    }

    .navbar-nav {
        display: -ms-flexbox;
        display: flex;
        -ms-flex-direction: column;
        flex-direction: column;
        padding-left: 0;
        margin-bottom: 0;
        list-style: none;
    }

    .navbar-collapse {
        -ms-flex-preferred-size: 100%;
        flex-basis: 100%;
        -ms-flex-positive: 1;
        flex-grow: 1;
        -ms-flex-align: center;
        align-items: center;
    }

    .navbar-toggler {
        padding: 0.25rem 0.75rem;
        font-size: 1.25rem;
        line-height: 1;
        background-color: transparent;
        border: 1px solid transparent;
        border-radius: 0.25rem;
    }

    .navbar-toggler:hover,
    .navbar-toggler:focus {
        text-decoration: none;
    }

    @media (min-width: 992px) {
        .navbar-expand-lg {
            -ms-flex-flow: row nowrap;
            flex-flow: row nowrap;
            -ms-flex-pack: start;
            justify-content: flex-start;
        }

        .navbar-expand-lg .navbar-nav {
            -ms-flex-direction: row;
            flex-direction: row;
        }

        .navbar-expand-lg .navbar-collapse {
            display: -ms-flexbox !important;
            display: flex !important;
            -ms-flex-preferred-size: auto;
            flex-basis: auto;
        }

        .navbar-expand-lg .navbar-toggler {
            display: none;
        }
    }

    @media (max-width: 991px) {
        #navbarSupportedContent {
            display: none;
        }
    }
</style>
<nav class="navbar navbar-expand-lg">
    <div class="navbar-brand">
        <img class="user-avatar" src="/images/avatar.png" alt="头像">
        <div class="site-name gt-c-content-color-first">
            GeekGhc&#39;s Blog
        </div>
    </div>
    <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent"
        aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
        <i class="fas fa-bars gt-c-content-color-first" style="font-size: 18px"></i>
    </button>
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
        <div class="navbar-nav mr-auto" style="text-align: center">
            
            <div class="nav-item">
                
                <a href="/" class="menu gt-a-link">
                    首页
                </a>
                
            </div>
            
            <div class="nav-item">
                
                <a href="/archives" class="menu gt-a-link">
                    归档
                </a>
                
            </div>
            
            <div class="nav-item">
                
                <a href="/tags" class="menu gt-a-link">
                    Tags
                </a>
                
            </div>
            
            <div class="nav-item">
                
                <a href="/post/about" class="menu gt-a-link">
                    关于
                </a>
                
            </div>
            
        </div>
        <div style="text-align: center">
            <form id="gridea-search-form" style="position: relative" data-update="1736692760153"
                action="/search/index.html">
                <input class="search-input" autocomplete="off" spellcheck="false" name="q" placeholder="搜索文章" />
                <i class="fas fa-search gt-c-content-color-first" style="position: absolute; top: 9px; left: 10px;"></i>
            </form>
        </div>
    </div>
</nav>
<script>
    /* 移动端导航栏展开/收起切换 */
    document.getElementById('changeNavbar').onclick = function () {
        var element = document.getElementById('navbarSupportedContent');
        if (element.style.display === 'none' || element.style.display === '') {
            element.style.display = 'block';
        } else {
            element.style.display = 'none';
        }
    }
</script>
    <div class="post-container">
        <div class="post-detail gt-bg-theme-color-second">
            <article class="gt-post-content">
                <h2 class="post-title">
                    Laravel API开发初探
                </h2>
                <div class="post-info">
                    <time class="post-time gt-c-content-color-first">
                        · 2017-03-18 ·
                    </time>
                    
                        <a href="https://GeekGhc.github.io/tag/x4piCdT_z/" class="post-tags">
                            # PHP
                        </a>
                    
                        <a href="https://GeekGhc.github.io/tag/b0tSda50f/" class="post-tags">
                            # Laravel
                        </a>
                    
                </div>
                <div class="post-content">
                    <p>在Web开发，Api开发是一项非常重要的技术，这里就以Laravel项目实例来开发API 熟悉下API的具体的流程</p>
<h2 id="介绍">介绍</h2>
<p>关于<code>API</code>的开发 这在每个开发语言里都会有对应的开发方法 在<code>Python</code>里我们会用<code>django</code>框架去开发我们的<code>API</code></p>
<p>在<code>Laravel</code>里我们会用<code>Dingo</code>结合<code>JWT</code>认证去开发我们的<code>API</code> 而这里我们就以<code>Laravel</code>项目为例 来开发我们的<code>API</code> 熟悉一下在<br>
项目里是怎么去开发<code>API</code></p>
<blockquote>
<p>本文基于laravist的Api的开发教程  作为笔记参考</p>
</blockquote>
<h2 id="初始化数据">初始化数据</h2>
<p>因为我们这里是以<code>laravel</code>项目，所以我们可以先去生成一些测试数据 为了方便后面的数据操作</p>
<p>在项目终端目录执行:</p>
<pre><code class="language-shell">$ php artisan make:model Post -m
</code></pre>
<p>在生成的<code>posts table</code>里去定义数据字段</p>
<pre><code class="language-php?start_inline=1">Schema::create('posts', function (Blueprint $table) {
    $table-&gt;increments('id');
    $table-&gt;string('title');
    $table-&gt;text('body');
    $table-&gt;boolean('free');
    $table-&gt;timestamps();
});
</code></pre>
<p>接着去定义数据<code>ModelFactory</code></p>
<pre><code class="language-php?start_inline=1">$factory-&gt;define(App\Post::class, function (Faker\Generator $faker) {
    return [
        'title' =&gt; $faker-&gt;sentence,
        'body' =&gt; $faker-&gt;paragraph,
        'free' =&gt; $faker-&gt;boolean()
    ];
});
</code></pre>
<p>接着为这个<code>model</code>生成相应的控制器:</p>
<pre><code class="language-shell">$ php artisan make:controller PostController
</code></pre>
<p>接着迁移我们的数据表</p>
<pre><code class="language-shell">$ php artisan migrate
</code></pre>
<p>因为之前已经定义好了<code>ModelFactory</code> 所以我们去生成一些测试数据</p>
<pre><code class="language-shell">$ php artisan tinker;
$ namespace App;
$ factory(Post::class,40)-&gt;create()
</code></pre>
<p>到这里我们的测试数据就已经准备好了</p>
<h2 id="路由定义">路由定义</h2>
<p>为了更好的熟悉<code>api</code>的路由 首先我们可以像往常web路由的定义一样去定义我们这个<code>Post</code>的一系列路由</p>
<pre><code class="language-php?start_inline=1">Route::group(['prefix'=&gt;'api/v1'],function (){
    Route::resource('posts','PostController');
});
</code></pre>
<p>其实这个时候去查看一下路由 所看到的路由方式和我们的实际<code>api</code>开发的路由是差不多的</p>
<p>你也可以去看一些平台的<code>api</code>的文档 你会发现也都是遵循这样的规则 说到<code>api</code>的开发规则</p>
<p>现在基本也都遵循了<code>Restful api</code>的开发准则 网上相关的说明教程也很多这里推荐一个阮一峰的一篇文章</p>
<blockquote>
<p><a href="http://www.ruanyifeng.com/blog/2014/05/restful_api.html">RESTful API 设计指南</a></p>
</blockquote>
<p>定义好了路由我们可以尝试着自己去实现下数据的操作 比如数据的全部显示</p>
<p>所以在<code>PostController</code>的<code>index</code>方法中就可以直接返回所有数据(这里只做测试显示 实际开发中是不会这样暴露全部数据的)</p>
<pre><code class="language-php?start_inline=1">public function index()
{
    return Post::all();
}
</code></pre>
<p>这样的话我们去启动服务访问<a href="http://localhost:8000/api/v1/posts">http://localhost:8000/api/v1/posts</a>这个路由的话理应是可以返回所有的数据的</p>
<p>当然如果是去指定的数据的话 按照<code>api</code>的设计要求就可以在<code>url</code>后面加上对应的<code>id</code>即可</p>
<p>所以这个时候我们在控制器里可以这样写</p>
<pre><code class="language-php?start_inline=1">public function show($id)
{
    $post = Post::findOrFail($id);
    return $post;
}
</code></pre>
<p>同样的我们这个时候在请求这条<code>api</code>时就是<a href="http://localhost:8000/api/v1/posts/3">http://localhost:8000/api/v1/posts/3</a></p>
<h2 id="字段映射">字段映射</h2>
<p>通常的我们在请求一个服务的<code>api</code>时会附加一些信息 如状态码等 这些信息都是必须的 但是我们的数据库里是没有这些信息数据的</p>
<p>再者就是数据库里的字段我们不会想要把他们全部反馈给用户 比如我们的时间戳等用户并不需要的信息</p>
<p>所以说在这里我们就需要对字段进行映射 以满足我们对数据的请求</p>
<p>在<code>Laravel</code>中我们可以在<code>Response</code>里去完善我们的返回信息 如:</p>
<pre><code class="language-php?start_inline=1">public function index()
{
    $posts = Post::all();
    return \Response::json([
        'status_code'=&gt;200,
        'data' =&gt; $posts-&gt;toArray()
    ]);
}
</code></pre>
<p>在选取本地的数据库字段时我们完全可以自己去实现这个方法</p>
<pre><code class="language-php?start_inline=1">public function transform($posts)
{
    return array_map(function($post){
        return [
            'title' =&gt;$post['title'],
            'content'=&gt;$post['body'],
            'is_free'=&gt;$post['free']
        ];
    },$posts-&gt;toArray());
}
</code></pre>
<p>这里的<code>transform function</code>就是对字段做了映射 所以在获取信息时调用这个方法即可</p>
<pre><code class="language-php?start_inline=1">$posts = Post::all();
return \Response::json([
    'status_code'=&gt;200,
    'data' =&gt; $$this-&gt;transform($posts)
]);
</code></pre>
<p>这样我们再去请求所有的数据时只会返回<code>title</code> <code>content</code>和<code>is_free</code>而这三个字段分别对应着数据表的<code>title</code> <code>body</code>和<code>free</code></p>
<p>当然这里只是对一个<code>Collection</code>进行的映射 那么对一条数据呢 为了更好的重用 我们可以去分离这部分代码</p>
<p>所以我们在<code>app</code>目录下去创建<code>Transformer</code>目录 在这个目录里面去创建一个<code>Transformer</code>的抽象类</p>
<pre><code class="language-php?start_inline=1">&lt;?php
namespace App\Transformer;

abstract class Transformer
{
    /**
     * @param $items
     * @return array
     */
    public function transformCollection($items)
    {
        return array_map([$this, 'transform'], $items);
    }

    /**
     * @param $item
     * @return mixed
     */
    public abstract function transform($item);
}
</code></pre>
<p>这里的抽象类我们可以继承之后对相应的数据表的字段进行映射<br>
所以这里我们对<code>posts</code>表的字段进行映射时 我们就去创建<code>PostTransformer</code>类</p>
<pre><code class="language-php?start_inline=1">&lt;?php
namespace App\Transformer;
class PostTransformer extends Transformer
{
    /**
     * @param $item
     * @return array
     */
    public function transform($item)
    {
        return [
            'title' =&gt; $item['title'],
            'content' =&gt; $item['body'],
            'is_free' =&gt; $item['free']
        ];
    }

}
</code></pre>
<p>这样定义完毕之后再去控制器里依赖注入这个<code>PostTransformer</code>即可</p>
<h2 id="请求错误返回">请求错误返回</h2>
<p>有些时候并不是所有请求都会得到正确的信息返回的 比方说错误的参数和不存在的数据 用户想要请求<code>id</code>为<strong>99</strong>的这条数据</p>
<p>但实际上并不存在这条数据 所以这时候我们会返回这种错误处理信息</p>
<p>对于这样的场景 我们目前能想象得到的就是判断对应的请求信息 如果正确即返回 否则返回错误信息 比如说常见的404错误</p>
<p>这时在定义<code>show</code>方法时 我们就可以加一个判断处理</p>
<pre><code class="language-php?start_inline=1">public function show($id)
{
    $post = Post::find($id);
    if(! $post){
        return \Response::json([
            'status_code'=&gt;404,
            'message'=&gt;&quot;post not found!&quot;
        ]);
    }
    return \Response::json([
        'status_code'=&gt;200,
        'data' =&gt; $this-&gt;postTransformer-&gt;transform($post)
    ]);
}
</code></pre>
<p>为了更好的管理返回信息的处理 我们可以把这部分代码抽离出来</p>
<pre><code class="language-shell">$ php artisan make:controller ApiStatusCoontroller
</code></pre>
<p>在这个控制器里主要就是去实现各种状态信息的返回 这样我们在业务代码里只需要调用相应的状态函数即可</p>
<pre><code class="language-php?start_inline=1">&lt;?php
namespace App\Http\Controllers;
use Illuminate\Http\Request;
use App\Http\Requests;

class ApiStatusController extends Controller
{
    protected $statusCode = 200;//默认状态码

    /**
     * @return int
     */
    public function getStatusCode()
    {
        return $this-&gt;statusCode;
    }

    /**
     * @param int $statusCode
     */
    public function setStatusCode($statusCode)
    {
        $this-&gt;statusCode = $statusCode;

        return $this;
    }

    public function responseNotFound($message = 'Not found')
    {
        return $this-&gt;setStatusCode(404)-&gt;responseError($message);
    }

    public function responseError($message)
    {
        return $this-&gt;response([
            'error'=&gt;[
                'status_code' =&gt; $this-&gt;getStatusCode(),
                'message' =&gt; $message
            ],
        ]);
    }
    
    public function response($data)
    {
        return \Response::json($data,$this-&gt;getStatusCode());
    }
}
</code></pre>
<p>这样一来如果我们需要返回错误处理的话 我们在目前的控制器 比如说<code>PostController</code>继承<code>ApiStatusController</code></p>
<p>然后在返回错误信息时就可以直接调用</p>
<p>这样和之前其实是一样的 如果是正确的返回则直接调用<code>response</code>方法</p>
<pre><code class="language-php?start_inline=1">public function show($id)
{
    $post = Post::find($id);
    if(! $post){
        return $this-&gt;responseNotFound();
    }
    return $this-&gt;response([
        'status' =&gt; 'success',
        'data' =&gt; $this-&gt;postTransformer-&gt;transform($lesson)
    ]);
}
</code></pre>

                </div>
            </article>
        </div>

        
            <div class="next-post">
                <div class="next gt-c-content-color-first">下一篇</div>
                <a href="https://GeekGhc.github.io/post/laravel-yong-hu-zhi-jian-fa-song-si-xin/" class="post-title gt-a-link">
                    Laravel用户之间发送私信
                </a>
            </div>
        

        
            <span id="/post/laravel-api-kai-fa-chu-tan/" class="leancloud_visitors" data-flag-title="Laravel API开发初探">
                <em class="post-meta-item-text">阅读量 </em>
                <i class="leancloud-visitors-count">0</i>
            </span>
        

        

        
            <script src='https://cdn.jsdelivr.net/npm/valine/dist/Valine.min.js'></script>

<style>
	div#vcomments{
		width:100%;
		max-width: 1000px;
		padding: 2.5%
	}
</style>


	<div id="vcomments"></div>

<script>
	new Valine({
		el: '#vcomments',
		appId: '',
		appKey: '',
		avatar: 'retro',
		pageSize: 10,
		recordIp: true,
		placeholder: 'everything you want to say',
		visitor: true,
	});
</script>

        

        <div class="site-footer gt-c-content-color-first">
    <div class="slogan gt-c-content-color-first">生活不止于工作，是的，我很棒 ^=^</div>
    <div class="social-container">
        
            
                <a href="https://github.com/GeekGhc" target="_blank">
                    <i class="fab fa-github gt-c-content-color-first"></i>
                </a>
            
        
            
        
            
        
            
        
            
        
            
        
    </div>
    <div class="footer-info">
        Powered by <a href="https://github.com/GeekGhc" target="_blank">ByteWriter</a>
    </div>
    <div>
        Theme by <a href="https://imhanjie.com/" target="_blank">imhanjie</a>, Powered by <a
                href="https://github.com/getgridea/gridea" target="_blank">Gridea | <a href="https://GeekGhc.github.io/atom.xml" target="_blank">RSS</a></a>
    </div>
</div>

<script>
  hljs.initHighlightingOnLoad()
</script>

    </div>
</div>
</body>
</html>
